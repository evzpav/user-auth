# --- Base ----
FROM golang:1.13-stretch AS base
WORKDIR $GOPATH/src/gitlab.com/evzpav/documents

# ---- Dependencies ----
FROM base AS dependencies
ENV GO111MODULE=on
COPY go.mod .
COPY go.sum .
RUN go mod download

# ---- Build ----
FROM dependencies AS build
COPY . .
ARG VERSION
ARG BUILD
ARG DATE
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -v -a -installsuffix cgo -o /go/bin/documents -ldflags "-X main.version=${VERSION} -X main.build=${BUILD} -X main.date=${DATE}" ./cmd/documents

# --- Release ----
FROM myregistry/platform/docker-base-image:stable AS image
COPY --from=build /go/bin/documents /documents
ENTRYPOINT ["/documents"]
